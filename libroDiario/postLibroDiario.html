<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alta de Asientos</title>
    <link rel="stylesheet" href="../styles.css">
</head>
<body>

    <h2>Alta de Asientos</h2>

    <form id="configuracionAsientoForm">
        <label for="nroAsiento">Nro Asiento:</label>
        <input type="number" id="nroAsiento" name="nroAsiento" required>
        <label for="fecha">Fecha:</label>
        <input type="date" id="fecha" name="fecha" required><br>
        <label for="cantidadItems">Cantidad de Ítems:</label>
        <input type="number" id="cantidadItems" name="cantidadItems" required>
        <button type="button" onclick="configurarAsiento()">Confirmar Cantidad</button>
    </form>

    <script>
        function configurarAsiento() {
            // Obtener la cantidad de ítems ingresada
            const cantidadItems = document.getElementById('cantidadItems').value;

            // Validar que la cantidad de ítems sea un número positivo
            if (isNaN(cantidadItems) || cantidadItems <= 0) {
                alert("Por favor, ingrese un número válido y positivo para la cantidad de ítems.");
                return;
            }

            // Eliminar el formulario existente si hay alguno
            const existingForm = document.getElementById('asientoForm');
            if (existingForm) {
                existingForm.remove();
            }

            // Crear un nuevo formulario con los campos necesarios
            const newForm = document.createElement('form');
            newForm.id = 'asientoForm';

            for (let i = 1; i <= cantidadItems; i++) {
                // Crear div contenedor para cada ítem
                const itemContainer = document.createElement('div');
                itemContainer.className = 'item-container';

                // Agregar campos para cada ítem
                itemContainer.innerHTML = `
                    <label for="tipoMovimiento${i}">Tipo de Movimiento ${i}:</label>
                    <select id="tipoMovimiento${i}" name="tipoMovimiento${i}" class="select-container" required>
                        <option value="debe">Debe</option>
                        <option value="haber">Haber</option>
                    </select>

                    <label for="importe${i}">Importe ${i}:</label>
                    <input type="number" id="importe${i}" name="importe${i}" required>

                    <label for="cuenta${i}">Cuenta ${i}:</label>
                    <select id="cuenta${i}" name="cuenta${i}" class="select-container" onchange="obtenerFKMayor(${i})" required></select>

                    <!-- Agregado: input para el código mayor -->
                    <input type="hidden" id="mayor${i}" name="mayor${i}">

                    <br><br>
                `;

                // Agregar el contenedor del ítem al formulario
                newForm.appendChild(itemContainer);
            }

            // Agregar el botón "Guardar Asiento"
            newForm.innerHTML += `<button type="button" onclick="guardarAsientos()">Guardar Asientos</button>`;

            // Agregar el nuevo formulario al cuerpo del documento
            document.body.appendChild(newForm);

            // Llenar el combobox al cargar la página
            llenarComboBox(cantidadItems);
        }

        // Función para llenar el combobox con las descripciones de la base de datos
        function llenarComboBox(cantidadItems) {
            // Cambié la URL para solicitar descripciones del plan de cuentas
            fetch('apiLibroDiario.php?tipo=descripciones_plan_de_cuentas')
            .then(response => response.json())
            .then(data => {
                // Iterar sobre los campos de cuenta en el formulario
                for (let i = 1; i <= cantidadItems; i++) {
                    // Obtener el elemento select (combobox)
                    const comboBox = document.getElementById(`cuenta${i}`);

                    // Limpiar opciones anteriores
                    comboBox.innerHTML = '';

                    // Iterar sobre los datos y agregar opciones al combobox
                    data.forEach(description => {
                        const option = document.createElement('option');
                        option.value = description;
                        option.text = description;
                        comboBox.appendChild(option);
                    });
                }
            })
            .catch(error => console.error('Error al obtener datos:', error));
        }

        // Función para obtener el dato requerido (FK_mayor) al seleccionar una cuenta
        function obtenerFKMayor(index) {
            const selectedCuenta = document.getElementById(`cuenta${index}`).value;

            // Realizar la solicitud GET para obtener el dato requerido
            fetch(`apiLibroDiario.php?tipo=FK_mayor&cuenta=${selectedCuenta}`)
            .then(response => response.json())
            .then(data => {
                // Obtener el elemento input para el código mayor
                const inputMayor = document.getElementById(`mayor${index}`);

                // Llenar el input con el dato requerido
                inputMayor.value = data.FK_mayor;

                // Imprimir el valor en la consola
                console.log(`Valor del input mayor${index}:`, inputMayor.value);
            })
            .catch(error => console.error('Error al obtener datos:', error));
        }

        function guardarAsientos() {
            // Obtener la cantidad de ítems ingresada
            const cantidadItems = document.getElementById('cantidadItems').value;

            // Recorrer todos los ítems
            for (let i = 1; i <= cantidadItems; i++) {
                // Llamar a la función guardarAsientos(index) para cada ítem
                guardarAsiento(i);
            }
        }

        // Función para guardar el asiento
        function guardarAsiento(index) {
            // Obtener los elementos del formulario específico
            const nroAsiento=document.getElementById(`nroAsiento`).value;
            const fecha=document.getElementById(`fecha`).value;
            const tipoMovimiento = document.getElementById(`tipoMovimiento${index}`).value;
            const importe = document.getElementById(`importe${index}`).value;
            const cuenta = document.getElementById(`cuenta${index}`).value;
            const mayor = document.getElementById(`mayor${index}`).value;

            // Crear un nuevo objeto FormData
            const formData = new FormData();
            
            // Agregar datos al formulario específico
            formData.append('itemIndex', index);
            formData.append('nroAsiento', nroAsiento);
            formData.append('fecha', fecha);
            formData.append('tipoMovimiento', tipoMovimiento);
            formData.append('importe', importe);
            formData.append('cuenta', cuenta);
            formData.append('mayor', mayor);

            for (const entry of formData.entries()) {
                console.log(entry);
            }

            // Realizar la solicitud POST para enviar los datos a apiLibroDiario.php
            fetch('apiLibroDiario.php', {
                method: 'POST',
                body: formData,
            })
            .then(response => response.json())
            .then(data => {
                // Manejar la respuesta del servidor
                console.log(`Respuesta del servidor para el ítem ${index}:`, data);
                // Aquí puedes realizar acciones adicionales si es necesario
            })
            .catch(error => console.error('Error al enviar datos:', error));
        }
    </script>

</body>
</html>
